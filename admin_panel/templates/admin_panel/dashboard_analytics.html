<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analytics - Sistema de Notas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-btn {
            color: white;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/admin-tools/" class="back-btn">← Voltar ao Dashboard</a>
        <h1>Dashboard Analytics</h1>
        <div></div>
    </div>
<div class="dashboard-analytics">
    <h1>Dashboard Analítico</h1>
    
    <!-- Cards de Resumo -->
    <div class="stats-cards">
        <div class="stat-card">
            <h3 id="total-turmas">0</h3>
            <p>Total de Turmas</p>
        </div>
        <div class="stat-card">
            <h3 id="total-alunos">0</h3>
            <p>Total de Alunos</p>
        </div>
        <div class="stat-card">
            <h3 id="total-notas">0</h3>
            <p>Notas Lançadas</p>
        </div>
        <div class="stat-card">
            <h3 id="total-professores">0</h3>
            <p>Professores</p>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="charts-container">
        <!-- Progresso por Tipo de Turma -->
        <div class="chart-card">
            <h2>Progresso por Tipo de Turma</h2>
            <canvas id="tiposProgressoChart"></canvas>
        </div>

        <!-- Performance dos Professores -->
        <div class="chart-card">
            <h2>Performance dos Professores</h2>
            <canvas id="professoresChart"></canvas>
        </div>

        <!-- Estatísticas de Competências -->
        <div class="chart-card">
            <h2>Competências - Médias</h2>
            <canvas id="competenciasChart"></canvas>
        </div>

        <!-- Distribuição de Notas (para competências categóricas) -->
        <div class="chart-card">
            <h2>Distribuição de Notas Categóricas</h2>
            <canvas id="distribuicaoChart"></canvas>
        </div>
    </div>
</div>

<style>
.dashboard-analytics {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-card h3 {
    font-size: 2.5em;
    margin: 0;
    font-weight: bold;
}

.stat-card p {
    margin: 10px 0 0 0;
    opacity: 0.9;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
}

.chart-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.chart-card h2 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 1.5em;
}

canvas {
    max-width: 100%;
    height: 300px !important;
}

@media (max-width: 768px) {
    .charts-container {
        grid-template-columns: 1fr;
    }
    
    .chart-card {
        min-width: auto;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Buscar dados da API
    fetch('{% url "admin_panel:analytics_data" %}')
        .then(response => response.json())
        .then(data => {
            // Atualizar cards de resumo
            document.getElementById('total-turmas').textContent = data.resumo.total_turmas;
            document.getElementById('total-alunos').textContent = data.resumo.total_alunos;
            document.getElementById('total-notas').textContent = data.resumo.total_notas;
            document.getElementById('total-professores').textContent = data.resumo.total_professores;

            // Gráfico de Progresso por Tipo de Turma
            const tiposCtx = document.getElementById('tiposProgressoChart').getContext('2d');
            new Chart(tiposCtx, {
                type: 'bar',
                data: {
                    labels: data.tipos_progresso.map(t => t.nome),
                    datasets: [{
                        label: 'Progresso (%)',
                        data: data.tipos_progresso.map(t => t.progresso),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)',
                            'rgba(255, 99, 255, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(199, 199, 199, 1)',
                            'rgba(83, 102, 255, 1)',
                            'rgba(255, 99, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const item = data.tipos_progresso[context.dataIndex];
                                    return [
                                        `Turmas: ${item.turmas_count}`,
                                        `Notas Lançadas: ${item.notas_lancadas}`,
                                        `Notas Possíveis: ${item.notas_possiveis}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Performance dos Professores
            const profCtx = document.getElementById('professoresChart').getContext('2d');
            new Chart(profCtx, {
                type: 'bar',
                data: {
                    labels: data.professores_stats.map(p => p.nome),
                    datasets: [{
                        label: 'Progresso (%)',
                        data: data.professores_stats.map(p => p.progresso),
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const prof = data.professores_stats[context.dataIndex];
                                    return [
                                        `Turmas: ${prof.turmas_count}`,
                                        `Alunos: ${prof.alunos_count}`,
                                        `Notas: ${prof.notas_lancadas}/${prof.notas_possiveis}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Competências (apenas numéricas)
            const competenciasNumericas = data.competencias_stats.filter(c => c.tipo === 'Numérica');
            if (competenciasNumericas.length > 0) {
                const compCtx = document.getElementById('competenciasChart').getContext('2d');
                new Chart(compCtx, {
                    type: 'line',
                    data: {
                        labels: competenciasNumericas.map(c => c.nome),
                        datasets: [{
                            label: 'Média das Notas',
                            data: competenciasNumericas.map(c => c.media),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const comp = competenciasNumericas[context.dataIndex];
                                        return `Total de Notas: ${comp.total_notas}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Gráfico de Distribuição (competências categóricas)
            const competenciasCategoricas = data.competencias_stats.filter(c => c.tipo === 'Categórica');
            if (competenciasCategoricas.length > 0) {
                // Pegar a primeira competência categórica como exemplo
                const primeiraCateg = competenciasCategoricas[0];
                const distCtx = document.getElementById('distribuicaoChart').getContext('2d');
                new Chart(distCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(primeiraCateg.distribuicao),
                        datasets: [{
                            data: Object.values(primeiraCateg.distribuicao),
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: primeiraCateg.nome
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
        });
});
</script>

</body>
</html>